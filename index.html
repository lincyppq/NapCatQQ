
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NapCat ç®¡ç†ç»ˆç«¯</title>
    <link rel="stylesheet" href="index.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        const App = () => {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const apiHost = ''; 

            const handleLogin = (newToken) => {
                setToken(newToken);
                localStorage.setItem('token', newToken);
            };

            const handleLogout = () => {
                setToken(null);
                localStorage.removeItem('token');
            };

            useEffect(() => {
                if (token) {
                    fetch(`${apiHost}/api/admin/config`, { headers: { 'Authorization': `Bearer ${token}` } })
                        .then(r => r.json())
                        .then(config => {
                            if (config.uiTheme) applyTheme(config.uiTheme);
                        })
                        .catch(() => {});
                }
            }, [token]);

            const applyTheme = (theme) => {
                const target = document.body; 
                if (theme.primaryColor) target.style.setProperty('--primary', theme.primaryColor);
                if (theme.backgroundImage) {
                    target.style.setProperty('--bg-image', `url('${theme.backgroundImage}')`);
                } else {
                    target.style.removeProperty('--bg-image');
                }
                if (theme.overlayOpacity !== undefined) {
                    target.style.setProperty('--bg-overlay-opacity', theme.overlayOpacity);
                }
            };

            if (!token) return <LoginScreen onLogin={handleLogin} apiHost={apiHost} />;
            return <Dashboard token={token} apiHost={apiHost} onLogout={handleLogout} applyTheme={applyTheme} />;
        };

        const LoginScreen = ({ onLogin, apiHost }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${apiHost}/api/login`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        onLogin(data.token);
                    } else {
                        const errData = await res.json();
                        setError(errData.error || 'è®¤è¯å¤±è´¥');
                    }
                } catch (err) { setError(`è¿æ¥å¤±è´¥: ${err.message}`); } 
                finally { setLoading(false); }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <h2>NapCat Admin</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="stat-label" style={{textAlign:'left', marginLeft:'4px'}}>è´¦å·</label>
                                <input type="text" className="form-control" value={username} onChange={e => setUsername(e.target.value)} placeholder="Username" />
                            </div>
                            <div className="form-group">
                                <label className="stat-label" style={{textAlign:'left', marginLeft:'4px', marginTop:'1rem'}}>å¯†ç </label>
                                <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" />
                            </div>
                            {error && <div style={{color:'#FF453A', margin:'1.5rem 0', fontSize:'0.9rem'}}>{error}</div>}
                            <button type="submit" className="btn btn-primary" style={{width:'100%', marginTop:'1.5rem'}} disabled={loading}>
                                {loading ? 'Wait...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ token, apiHost, onLogout, applyTheme }) => {
            const [bots, setBots] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingBot, setEditingBot] = useState(null);
            const [msgBot, setMsgBot] = useState(null);
            const [showAdmin, setShowAdmin] = useState(false);
            const [showLogs, setShowLogs] = useState(false);
            const [showAddBot, setShowAddBot] = useState(false);
            const [showLoginHistory, setShowLoginHistory] = useState(false);
            const [showRecycleBin, setShowRecycleBin] = useState(false);
            const [showSearch, setShowSearch] = useState(false);
            const [wsUrl, setWsUrl] = useState('');

            useEffect(() => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                setWsUrl(`${protocol}//${window.location.host}/ws/napcat`);
            }, []);

            const fetchBots = async () => {
                try {
                    const res = await fetch(`${apiHost}/api/bots`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.status === 401 || res.status === 403) { onLogout(); return; }
                    const data = await res.json();
                    setBots(data);
                    
                    setEditingBot(prev => {
                        if (!prev) return null;
                        return data.find(b => b.id === prev.id) || prev;
                    });
                } catch (err) { console.error(err); } finally { setLoading(false); }
            };

            useEffect(() => {
                fetchBots();
                const interval = setInterval(fetchBots, 5000);
                return () => clearInterval(interval);
            }, [token]);

            const handleGlobalSearchSelect = (botId, contract) => {
                const bot = bots.find(b => b.id === botId);
                if (bot) {
                    setEditingBot(bot);
                }
            };

            return (
                <div className="dashboard">
                    <div className="header-ornament">
                        <div className="header-title">
                            <span>NapCat Admin</span>
                            <span className="header-subtitle" style={{opacity: 0.6}}>WS: {wsUrl}</span>
                        </div>
                        
                        <button onClick={() => setShowAddBot(true)} className="nav-btn" title="æ–°å¢">ï¼‹</button>
                        <button onClick={() => setShowSearch(true)} className="nav-btn" title="å…¨å±€æœç´¢">ğŸ”</button>
                        <button onClick={() => setShowRecycleBin(true)} className="nav-btn" title="å›æ”¶ç«™">â™»ï¸</button>
                        <button onClick={() => setShowLoginHistory(true)} className="nav-btn" title="å†å²">ğŸ•’</button>
                        <button onClick={() => setShowLogs(true)} className="nav-btn" title="æ—¥å¿—">ğŸ“œ</button>
                        <button onClick={() => setShowAdmin(true)} className="nav-btn" title="è®¾ç½®">âš™ï¸</button>
                        <button onClick={onLogout} className="nav-btn" style={{color:'#FF453A'}} title="é€€å‡º">âœ•</button>
                    </div>

                    {loading && bots.length === 0 ? (
                        <div style={{textAlign:'center', color:'rgba(255,255,255,0.5)', fontSize:'1.2rem', marginTop:'20vh'}}>Loading...</div>
                    ) : (
                        <div className="grid">
                            {bots.map(bot => (
                                <BotCard key={bot.id} bot={bot} onEdit={() => setEditingBot(bot)} onMsg={() => setMsgBot(bot)} />
                            ))}
                            {bots.length === 0 && (
                                <div style={{gridColumn:'1/-1', textAlign:'center', padding:'4rem', color:'rgba(255,255,255,0.4)'}}>
                                    <div style={{fontSize:'3rem', marginBottom:'1rem'}}>ğŸš€</div>
                                    <h3>æš‚æ— å®ä¾‹</h3>
                                    <p>è¯·ç‚¹å‡» â€œï¼‹â€ æ–°å¢å®ä¾‹</p>
                                </div>
                            )}
                        </div>
                    )}

                    {editingBot && <EditBotModal bot={editingBot} token={token} apiHost={apiHost} onClose={() => setEditingBot(null)} onSuccess={fetchBots} />}
                    {msgBot && <SendMsgModal bot={msgBot} token={token} apiHost={apiHost} onClose={() => setMsgBot(null)} />}
                    {showAdmin && <AdminSettingsModal token={token} apiHost={apiHost} onClose={() => setShowAdmin(false)} onLogout={onLogout} applyTheme={applyTheme} />}
                    {showLogs && <LogViewerModal token={token} apiHost={apiHost} onClose={() => setShowLogs(false)} />}
                    {showLoginHistory && <LoginHistoryModal token={token} apiHost={apiHost} onClose={() => setShowLoginHistory(false)} />}
                    {showAddBot && <AddBotModal token={token} apiHost={apiHost} onClose={() => setShowAddBot(false)} onSuccess={fetchBots} />}
                    {showRecycleBin && <RecycleBinModal token={token} apiHost={apiHost} onClose={() => setShowRecycleBin(false)} onSuccess={fetchBots} />}
                    {showSearch && <GlobalSearchModal bots={bots} onClose={() => setShowSearch(false)} onSelect={handleGlobalSearchSelect} />}
                </div>
            );
        };

        const BotCard = ({ bot, onEdit, onMsg }) => {
            const activeContracts = bot.contracts?.filter(c => !c.expireTime || c.expireTime > Date.now()).length || 0;
            const hasCustomAvatar = bot.avatar && (bot.avatar.startsWith('http') || bot.avatar.startsWith('/'));
            
            return (
                <div className="bot-card">
                    <div className={`status-badge ${bot.isOnline ? 'status-online' : 'status-offline'}`}>
                        <span className="status-dot"></span>
                        <span>{bot.isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                    <div className="bot-info">
                        <div className="bot-avatar">
                            {hasCustomAvatar ? 
                                <img src={bot.avatar} alt="avatar" onError={(e)=>{e.target.style.display='none';e.target.parentElement.innerText='ğŸ‘¾'}} /> 
                                : (bot.avatar || 'ğŸ‘¾')
                            }
                        </div>
                        <div className="bot-details">
                            <h3>{bot.name}</h3>
                            <div className="bot-id">{bot.id}</div>
                        </div>
                    </div>
                    <div className="stats-row">
                        <div className="stat-item">
                            <span className="stat-label">ç”Ÿæ•ˆä¸­</span>
                            <span className="stat-value" style={{color: activeContracts > 0 ? 'var(--success)' : 'inherit'}}>{activeContracts}</span>
                        </div>
                        <div style={{width:'1px', background:'rgba(255,255,255,0.1)'}}></div>
                        <div className="stat-item">
                            <span className="stat-label">æ€»é…ç½®</span>
                            <span className="stat-value">{bot.contracts?.length || 0}</span>
                        </div>
                    </div>
                    <div className="actions">
                        <button className="btn btn-primary" onClick={onEdit}>ç®¡ç†</button>
                        <button className="btn btn-secondary" onClick={onMsg} disabled={!bot.isOnline}>å‘æ¶ˆæ¯</button>
                    </div>
                </div>
            );
        };

        const ContractEditor = ({ contract, botId, token, apiHost, onSave, onCancel }) => {
            const toLocalISO = (ts) => {
                if (!ts) return '';
                const d = new Date(ts);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                return d.toISOString().slice(0, 16);
            };

            const [groupId, setGroupId] = useState(contract ? contract.groupId : '');
            const [groupName, setGroupName] = useState(contract ? (contract.groupName || '') : '');
            const [expireTime, setExpireTime] = useState(contract ? toLocalISO(contract.expireTime) : '');
            const [avatarUrl, setAvatarUrl] = useState('');

            useEffect(() => { if (groupId) updateGroupInfo(groupId); }, []);

            const updateGroupInfo = (gid) => {
                if (!gid) return;
                setAvatarUrl(`https://p.qlogo.cn/gh/${gid}/${gid}/100`);
                if (!groupName) {
                    fetch(`${apiHost}/api/bot/group-info`, {
                        method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                        body: JSON.stringify({ botId, groupId: gid })
                    }).then(res => res.json()).then(data => { if (data.groupName) setGroupName(data.groupName); }).catch(() => {});
                }
            };

            const handleSave = () => {
                if (!groupId) return alert('è¯·è¾“å…¥ç¾¤å·');
                onSave({ contractId: contract?.id, groupId, groupName, expireTime: expireTime ? new Date(expireTime).getTime() : null });
            };

            const addTime = (days) => {
                const current = expireTime ? new Date(expireTime) : new Date();
                current.setDate(current.getDate() + days);
                setExpireTime(toLocalISO(current.getTime()));
            };

            return (
                <div style={{background:'rgba(255,255,255,0.03)', padding:'1.5rem', borderRadius:'var(--radius-md)', marginTop:'1rem'}}>
                    <h4 style={{marginBottom:'1rem'}}>{contract ? 'ç¼–è¾‘' : 'æ–°å¢'}</h4>
                    <div className="form-group" style={{display:'flex', gap:'1rem', alignItems:'center', flexWrap:'wrap'}}>
                        <div className="group-avatar" style={{width:'50px', height:'50px'}}>
                            {avatarUrl ? <img src={avatarUrl} style={{width:'100%', height:'100%', borderRadius:'50%'}} onError={e=>e.target.style.display='none'}/> : <div style={{width:'100%',height:'100%',background:'rgba(255,255,255,0.1)',borderRadius:'50%'}}></div>}
                        </div>
                        <div style={{flex:1, minWidth:'120px'}}>
                            <label className="stat-label">ç¾¤å·</label>
                            <input type="number" className="form-control" value={groupId} onChange={e => setGroupId(e.target.value)} onBlur={()=>updateGroupInfo(groupId)} placeholder="123456" />
                        </div>
                        <div style={{flex:1.5, minWidth:'150px'}}>
                            <label className="stat-label">å¤‡æ³¨/åç§°</label>
                            <input type="text" className="form-control" value={groupName} onChange={e => setGroupName(e.target.value)} placeholder="Name" />
                        </div>
                    </div>
                    
                    <div className="form-group" style={{marginTop:'1rem'}}>
                        <label className="stat-label">åˆ°æœŸæ—¶é—´</label>
                        <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap'}}>
                            <input type="datetime-local" className="form-control" style={{flex:1, minWidth:'200px'}} value={expireTime} onChange={e => setExpireTime(e.target.value)} />
                            <button className="btn btn-sm btn-secondary" onClick={() => addTime(30)}>+1æœˆ</button>
                            <button className="btn btn-sm btn-secondary" onClick={() => addTime(90)}>+1å­£</button>
                            <button className="btn btn-sm btn-secondary" onClick={() => addTime(365)}>+1å¹´</button>
                        </div>
                    </div>

                    <div style={{display:'flex', justifyContent:'flex-end', gap:'0.5rem', marginTop:'1.5rem'}}>
                        <button className="btn btn-secondary" onClick={onCancel}>å–æ¶ˆ</button>
                        <button className="btn btn-primary" onClick={handleSave}>ä¿å­˜</button>
                    </div>
                </div>
            );
        };

        const GhostScanModal = ({ bot, token, apiHost, onClose }) => {
            const [ghosts, setGhosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selected, setSelected] = useState(new Set());
            const [scanning, setScanning] = useState(false);

            const scan = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${apiHost}/api/bot/ghost-scan`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ botId: bot.id })
                    });
                    const data = await res.json();
                    if (res.ok) setGhosts(data);
                    else alert(data.error);
                } catch (e) { alert('æ‰«æå¤±è´¥'); } 
                finally { setLoading(false); }
            };

            useEffect(() => { scan(); }, []);

            const toggleSelect = (gid) => {
                const next = new Set(selected);
                if (next.has(gid)) next.delete(gid);
                else next.add(gid);
                setSelected(next);
            };

            const handleClean = async () => {
                if (selected.size === 0) return;
                if (!confirm(`ç¡®å®šè¦é€€å‡ºé€‰ä¸­çš„ ${selected.size} ä¸ªç¾¤èŠå—ï¼Ÿ`)) return;
                try {
                    const res = await fetch(`${apiHost}/api/bot/ghost-clean`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ botId: bot.id, groupIds: Array.from(selected) })
                    });
                    const data = await res.json();
                    alert(`å·²æˆåŠŸæ¸…ç† ${data.count} ä¸ªç¾¤`);
                    scan(); // refresh
                    setSelected(new Set());
                } catch (e) { alert('æ¸…ç†å¤±è´¥'); }
            };

            return (
                <div className="modal-overlay" style={{zIndex: 1100}} onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h3>ğŸ‘» å¹½çµç¾¤æ‰«æ</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div className="modal-body">
                            <p style={{color:'var(--text-secondary)', fontSize:'0.9rem', marginBottom:'1rem'}}>
                                å¹½çµç¾¤æŒ‡æœºå™¨äººå·²åŠ å…¥ï¼Œä½†æœªåœ¨é¢æ¿æˆæƒçš„ç¾¤ã€‚
                            </p>
                            {loading ? (
                                <div style={{textAlign:'center', padding:'2rem'}}>æ‰«æä¸­...</div>
                            ) : ghosts.length === 0 ? (
                                <div style={{textAlign:'center', padding:'2rem', color:'var(--success)'}}>âœ… æœªå‘ç°å¹½çµç¾¤</div>
                            ) : (
                                <div>
                                    <div style={{maxHeight:'300px', overflowY:'auto', border:'1px solid rgba(255,255,255,0.1)', borderRadius:'var(--radius-sm)', padding:'0.5rem'}}>
                                        {ghosts.map(g => (
                                            <div key={g.group_id} style={{display:'flex', alignItems:'center', padding:'0.5rem', borderBottom:'1px solid rgba(255,255,255,0.05)'}}>
                                                <input type="checkbox" checked={selected.has(g.group_id)} onChange={() => toggleSelect(g.group_id)} style={{marginRight:'10px'}} />
                                                <div>
                                                    <div>{g.group_name || g.group_id}</div>
                                                    <div style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>{g.group_id} ({g.member_count}äºº)</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div style={{marginTop:'1rem', display:'flex', justifyContent:'space-between'}}>
                                        <button className="btn btn-sm btn-secondary" onClick={() => {
                                            if (selected.size === ghosts.length) setSelected(new Set());
                                            else setSelected(new Set(ghosts.map(g => g.group_id)));
                                        }}>{selected.size === ghosts.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}</button>
                                        <button className="btn btn-sm btn-danger" disabled={selected.size===0} onClick={handleClean}>é€€å‡ºé€‰ä¸­ ({selected.size})</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalSearchModal = ({ bots, onClose, onSelect }) => {
            const [term, setTerm] = useState('');
            
            const results = useMemo(() => {
                if (!term) return [];
                const list = [];
                bots.forEach(bot => {
                    if (bot.contracts) {
                        bot.contracts.forEach(c => {
                            if (String(c.groupId).includes(term) || (c.groupName && c.groupName.includes(term))) {
                                list.push({ ...c, botName: bot.name, botId: bot.id });
                            }
                        });
                    }
                });
                return list;
            }, [term, bots]);

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h3>ğŸ” å…¨å±€æœç´¢</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div className="modal-body">
                            <div className="form-group">
                                <input className="form-control" value={term} onChange={e => setTerm(e.target.value)} placeholder="è¾“å…¥ç¾¤å·æˆ–ç¾¤åç§°..." autoFocus />
                            </div>
                            <div style={{marginTop:'1rem', maxHeight:'400px', overflowY:'auto'}}>
                                {term && results.length === 0 && <div style={{textAlign:'center', color:'var(--text-secondary)'}}>æœªæ‰¾åˆ°ç»“æœ</div>}
                                {results.map(item => (
                                    <div key={item.id} className="contract-item" style={{cursor:'pointer'}} onClick={() => { onSelect(item.botId, item); onClose(); }}>
                                        <div style={{display:'flex', alignItems:'center', gap:'0.8rem'}}>
                                            <img className="group-avatar" src={`https://p.qlogo.cn/gh/${item.groupId}/${item.groupId}/100`} />
                                            <div>
                                                <div style={{fontWeight:600}}>{item.groupName || item.groupId}</div>
                                                <div style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>
                                                    {item.botName} Â· {item.groupId}
                                                </div>
                                            </div>
                                        </div>
                                        <div style={{fontSize:'0.8rem', color: item.expireTime < Date.now() ? 'var(--danger)' : 'var(--success)'}}>
                                            {item.expireTime < Date.now() ? 'å·²è¿‡æœŸ' : 'ç”Ÿæ•ˆä¸­'}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EditBotModal = ({ bot, token, apiHost, onClose, onSuccess }) => {
            const [name, setName] = useState(bot.name);
            const [avatar, setAvatar] = useState(bot.avatar || '');
            const [contracts, setContracts] = useState(bot.contracts || []);
            const [editingContract, setEditingContract] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [realTimeGroups, setRealTimeGroups] = useState(new Set());
            const [showGhostScan, setShowGhostScan] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                setContracts(bot.contracts || []);
                setName(bot.name);
                setAvatar(bot.avatar || '');
            }, [bot]);

            useEffect(() => {
                if (bot.isOnline) {
                    fetch(`${apiHost}/api/bot/group-list`, {
                        method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                        body: JSON.stringify({ botId: bot.id })
                    }).then(res => res.json()).then(data => {
                        if (Array.isArray(data)) setRealTimeGroups(new Set(data.map(g => String(g.group_id))));
                    }).catch(err => console.error(err));
                }
            }, [bot.id, bot.isOnline]); 

            const handleSaveInfo = async () => {
                await fetch(`${apiHost}/api/bot/update-info`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id: bot.id, name, avatar })
                });
                onSuccess();
            };

            const handleUploadAvatar = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`${apiHost}/api/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
                    const data = await res.json();
                    setAvatar(data.url);
                } catch (err) { alert('ä¸Šä¼ å¤±è´¥'); }
            };

            const handleSaveContract = async (cData) => {
                await fetch(`${apiHost}/api/bot/contract/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ botId: bot.id, ...cData })
                });
                onSuccess();
                setEditingContract(null);
            };

            const handleDeleteContract = async (contractId) => {
                // Soft delete
                if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ(å°†ç§»å…¥å›æ”¶ç«™)')) return;
                await fetch(`${apiHost}/api/bot/contract/delete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ botId: bot.id, contractId })
                });
                onSuccess();
            };
            
            const handleDeleteBot = async () => {
                if (!confirm('ç¡®è®¤åˆ é™¤æ­¤æœºå™¨äººå®ä¾‹ï¼Ÿ(å°†ç§»å…¥å›æ”¶ç«™)')) return;
                await fetch(`${apiHost}/api/bot/delete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id: bot.id })
                });
                onClose();
                onSuccess();
            };

            const handleQuitGroup = async (groupId) => {
                if (!confirm(`ç¡®å®šé€€å‡ºç¾¤ ${groupId}ï¼Ÿ`)) return;
                await fetch(`${apiHost}/api/bot/quit-group`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ botId: bot.id, groupId })
                });
                onSuccess();
            };

            const filteredContracts = contracts.filter(c => String(c.groupId).includes(searchTerm) || (c.groupName && c.groupName.includes(searchTerm)));

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'800px'}}>
                        <div className="modal-header">
                            <h3>é…ç½®: {bot.name}</h3>
                            <button className="nav-btn" onClick={onClose}>âœ•</button>
                        </div>
                        <div className="modal-body" style={{display:'flex', gap:'2rem', flexDirection:'column'}}>
                            <div style={{display:'flex', gap:'1.5rem', alignItems:'center', background:'rgba(255,255,255,0.03)', padding:'1rem', borderRadius:'var(--radius-md)', flexWrap:'wrap'}}>
                                <div style={{position:'relative', margin:'0 auto'}}>
                                    <div className="bot-avatar" style={{width:'80px', height:'80px', fontSize:'2.5rem'}} onClick={() => fileInputRef.current.click()}>
                                        {avatar && (avatar.startsWith('http') || avatar.startsWith('/')) ? <img src={avatar} /> : (avatar || 'ğŸ‘¾')}
                                    </div>
                                    <input type="file" ref={fileInputRef} style={{display:'none'}} accept="image/*" onChange={handleUploadAvatar} />
                                    <div style={{fontSize:'0.7rem', textAlign:'center', marginTop:'0.5rem', color:'var(--primary)', cursor:'pointer'}} onClick={() => fileInputRef.current.click()}>æ›´æ¢</div>
                                </div>
                                <div style={{flex:1, minWidth:'200px'}}>
                                    <div className="form-group">
                                        <label className="stat-label">åç§°</label>
                                        <input className="form-control" value={name} onChange={e => setName(e.target.value)} />
                                    </div>
                                </div>
                                <div style={{display:'flex', gap:'0.5rem'}}>
                                    <button className="btn btn-primary" onClick={handleSaveInfo}>ä¿å­˜ä¿¡æ¯</button>
                                    <button className="btn btn-danger" onClick={handleDeleteBot}>åˆ é™¤å®ä¾‹</button>
                                </div>
                            </div>

                            <div>
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', flexWrap:'wrap', gap:'0.5rem'}}>
                                    <h4 style={{margin:0}}>ç§Ÿæˆ· ({contracts.length})</h4>
                                    <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                        {bot.isOnline && <button className="btn btn-sm btn-secondary" onClick={() => setShowGhostScan(true)}>ğŸ‘» æ‰«æå¹½çµç¾¤</button>}
                                        <input type="text" className="form-control" style={{padding:'0.4rem', width:'120px', fontSize:'0.9rem'}} placeholder="ğŸ” æœç´¢" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                        <button className="btn btn-sm btn-primary" onClick={() => setEditingContract({})}>+ æˆæƒ</button>
                                    </div>
                                </div>

                                {editingContract ? (
                                    <ContractEditor contract={editingContract.id ? editingContract : null} botId={bot.id} token={token} apiHost={apiHost} onSave={handleSaveContract} onCancel={() => setEditingContract(null)} />
                                ) : (
                                    <div className="contract-list" style={{maxHeight:'400px', overflowY:'auto'}}>
                                        {filteredContracts.map(c => {
                                            const isExpired = c.expireTime && Date.now() > c.expireTime;
                                            const daysLeft = c.expireTime ? Math.ceil((c.expireTime - Date.now()) / (1000 * 60 * 60 * 24)) : 'âˆ';
                                            const isMissing = bot.isOnline && !c.leftGroup && !realTimeGroups.has(String(c.groupId));
                                            return (
                                                <div className="contract-item" key={c.id}>
                                                    <div style={{display:'flex', alignItems:'center', gap:'1rem'}}>
                                                        <img className="group-avatar" src={`https://p.qlogo.cn/gh/${c.groupId}/${c.groupId}/100`} onError={e=>e.target.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22/>'} />
                                                        <div>
                                                            <div style={{fontWeight:'600', display:'flex', alignItems:'center', gap:'0.5rem', flexWrap:'wrap'}}>
                                                                {c.groupName || c.groupId}
                                                                {c.leftGroup && <span className="tag-left">å·²é€€ç¾¤</span>}
                                                                {isMissing && <span className="tag-missing">âš ï¸ ä¸åœ¨ç¾¤</span>}
                                                            </div>
                                                            <div style={{fontSize:'0.85rem', color:'var(--text-secondary)', marginTop:'2px'}}>
                                                                {c.groupId} Â· {isExpired ? <span style={{color:'var(--danger)'}}>è¿‡æœŸ</span> : <span style={{color:'var(--success)'}}>{daysLeft} å¤©</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style={{display:'flex', gap:'0.5rem'}}>
                                                        {!c.leftGroup && bot.isOnline && isExpired && (
                                                            <button className="btn btn-sm btn-warning" onClick={() => handleQuitGroup(c.groupId)}>é€€ç¾¤</button>
                                                        )}
                                                        <button className="btn btn-sm btn-secondary" onClick={() => setEditingContract(c)}>ç¼–è¾‘</button>
                                                        <button className="btn btn-sm btn-danger" onClick={() => handleDeleteContract(c.id)}>åˆ é™¤</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    {showGhostScan && <GhostScanModal bot={bot} token={token} apiHost={apiHost} onClose={() => setShowGhostScan(false)} />}
                </div>
            );
        };

        const SendMsgModal = ({ bot, token, apiHost, onClose }) => {
            const [groupId, setGroupId] = useState('');
            const [message, setMessage] = useState('');
            const [searchTerm, setSearchTerm] = useState('');

            const handleSend = async () => {
                if (!groupId || !message) return;
                try {
                    await fetch(`${apiHost}/api/bot/send`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ id: bot.id, group_id: groupId, message })
                    });
                    alert('å·²å‘é€');
                    onClose();
                } catch (e) { alert('å‘é€å¤±è´¥'); }
            };

            const filteredGroups = (bot.contracts || []).filter(c => String(c.groupId).includes(searchTerm) || (c.groupName && c.groupName.includes(searchTerm)));

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h3>å‘é€æ¶ˆæ¯</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label className="stat-label">ç¾¤å·</label>
                                <input className="form-control" type="number" value={groupId} onChange={e => setGroupId(e.target.value)} placeholder="ID" />
                            </div>
                            <div style={{marginTop:'1rem', marginBottom:'1.5rem'}}>
                                <input className="form-control" style={{fontSize:'0.85rem', padding:'0.5rem', marginBottom:'0.5rem'}} placeholder="ğŸ” æœç´¢" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <div style={{maxHeight:'150px', overflowY:'auto', background:'rgba(0,0,0,0.2)', borderRadius:'var(--radius-sm)', border:'1px solid rgba(255,255,255,0.1)'}}>
                                    {filteredGroups.map(c => (
                                        <div key={c.id} style={{padding:'8px', borderBottom:'1px solid rgba(255,255,255,0.05)', cursor:'pointer'}} onClick={() => setGroupId(c.groupId)}>{c.groupName || c.groupId}</div>
                                    ))}
                                </div>
                            </div>
                            <div className="form-group">
                                <label className="stat-label">å†…å®¹</label>
                                <textarea className="form-control" rows="4" value={message} onChange={e => setMessage(e.target.value)}></textarea>
                            </div>
                        </div>
                        <div className="modal-actions">
                            <button className="btn btn-primary" onClick={handleSend}>å‘é€</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RecycleBinModal = ({ token, apiHost, onClose, onSuccess }) => {
            const [data, setData] = useState({ bots: [], contracts: [] });
            const [tab, setTab] = useState('bots');

            const fetchData = () => {
                fetch(`${apiHost}/api/recycle-bin`, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(r => r.json())
                    .then(setData);
            };

            useEffect(() => { fetchData(); }, []);

            const handleRestore = async (type, id, botId) => {
                await fetch(`${apiHost}/api/recycle-bin/restore`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type, id, botId })
                });
                fetchData();
                onSuccess();
            };

            const handlePurge = async (type, id, botId) => {
                if(!confirm('å½»åº•åˆ é™¤ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) return;
                await fetch(`${apiHost}/api/recycle-bin/purge`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type, id, botId })
                });
                fetchData();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'600px'}}>
                        <div className="modal-header"><h3>â™»ï¸ å›æ”¶ç«™</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div style={{display:'flex', borderBottom:'1px solid rgba(255,255,255,0.1)', padding:'0 1rem'}}>
                            <div style={{padding:'1rem', cursor:'pointer', borderBottom: tab==='bots'?'2px solid var(--primary)':'none', color: tab==='bots'?'var(--primary)':'var(--text-secondary)'}} onClick={()=>setTab('bots')}>å·²åˆ é™¤å®ä¾‹ ({data.bots.length})</div>
                            <div style={{padding:'1rem', cursor:'pointer', borderBottom: tab==='contracts'?'2px solid var(--primary)':'none', color: tab==='contracts'?'var(--primary)':'var(--text-secondary)'}} onClick={()=>setTab('contracts')}>å·²åˆ é™¤æˆæƒ ({data.contracts.length})</div>
                        </div>
                        <div className="modal-body" style={{maxHeight:'60vh', overflowY:'auto'}}>
                            {tab === 'bots' && data.bots.map(b => (
                                <div key={b.id} className="contract-item">
                                    <div>
                                        <div style={{fontWeight:600}}>{b.name}</div>
                                        <div style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>ID: {b.id}</div>
                                    </div>
                                    <div style={{display:'flex', gap:'0.5rem'}}>
                                        <button className="btn btn-sm btn-success" style={{background:'rgba(48, 209, 88, 0.2)', color:'var(--success)'}} onClick={() => handleRestore('bot', b.id)}>æ¢å¤</button>
                                        <button className="btn btn-sm btn-danger" onClick={() => handlePurge('bot', b.id)}>å½»åº•åˆ é™¤</button>
                                    </div>
                                </div>
                            ))}
                            {tab === 'contracts' && data.contracts.map(c => (
                                <div key={c.id} className="contract-item">
                                    <div>
                                        <div style={{fontWeight:600}}>{c.groupName || c.groupId}</div>
                                        <div style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>æ‰€å±: {c.botName} ({c.botId})</div>
                                    </div>
                                    <div style={{display:'flex', gap:'0.5rem'}}>
                                        <button className="btn btn-sm btn-success" style={{background:'rgba(48, 209, 88, 0.2)', color:'var(--success)'}} onClick={() => handleRestore('contract', c.id, c.botId)}>æ¢å¤</button>
                                        <button className="btn btn-sm btn-danger" onClick={() => handlePurge('contract', c.id, c.botId)}>å½»åº•åˆ é™¤</button>
                                    </div>
                                </div>
                            ))}
                            {(tab === 'bots' && data.bots.length === 0) || (tab === 'contracts' && data.contracts.length === 0) ? <div style={{textAlign:'center', padding:'2rem', color:'var(--text-muted)'}}>ç©ºç©ºå¦‚ä¹Ÿ</div> : null}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminSettingsModal = ({ token, apiHost, onClose, onLogout, applyTheme }) => {
            const [config, setConfig] = useState(null);
            const [tab, setTab] = useState('basic'); 
            const [passData, setPassData] = useState({ newUsername: '', newPassword: '' });
            const [testTargetId, setTestTargetId] = useState('');
            const [backups, setBackups] = useState([]);
            
            useEffect(() => {
                fetch(`${apiHost}/api/admin/config`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(setConfig);
            }, []);

            useEffect(() => {
                if (tab === 'backup') {
                    fetch(`${apiHost}/api/backups`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(setBackups);
                }
            }, [tab]);

            const handleSaveConfig = async () => {
                await fetch(`${apiHost}/api/admin/config`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(config)
                });
                if (config.uiTheme) applyTheme(config.uiTheme); 
                alert('å·²ä¿å­˜');
            };

            const handleTestMsg = async (type) => {
                if (!testTargetId) return alert('è¾“å…¥æµ‹è¯•ç¾¤å·');
                try {
                    const res = await fetch(`${apiHost}/api/admin/test-msg`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ targetGroup: testTargetId, msgType: type })
                    });
                    if(res.ok) alert('å‘é€æˆåŠŸ');
                    else { const d = await res.json(); alert(d.error || 'å¤±è´¥'); }
                } catch(e) { alert('Error'); }
            };

            const uploadBg = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const fd = new FormData();
                fd.append('image', file);
                const res = await fetch(`${apiHost}/api/upload`, {method:'POST',headers:{'Authorization':`Bearer ${token}`}, body:fd});
                const d = await res.json();
                setConfig({...config, uiTheme: {...config.uiTheme, backgroundImage: d.url}});
            };

            const triggerBackup = async () => {
                await fetch(`${apiHost}/api/backup/now`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                alert('å¤‡ä»½å·²åˆ›å»º');
                fetch(`${apiHost}/api/backups`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(setBackups);
            };

            const downloadBackup = (filename) => {
                fetch(`${apiHost}/api/backup/${filename}`, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(res => res.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                    });
            };

            const restoreBackup = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                if(!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†è¦†ç›–å½“å‰çš„æœºå™¨äººæ•°æ®æˆ–ç³»ç»Ÿé…ç½®ï¼\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;

                const fd = new FormData();
                fd.append('file', file);

                try {
                    const res = await fetch(`${apiHost}/api/backup/restore`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd
                    });
                    const data = await res.json();
                    if(res.ok) {
                        alert(`æ¢å¤æˆåŠŸï¼\nç±»å‹: ${data.type}`);
                        window.location.reload();
                    } else {
                        alert(`æ¢å¤å¤±è´¥: ${data.error}`);
                    }
                } catch(e) { alert('æ¢å¤å‡ºé”™'); }
            };

            if (!config) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h3>ç³»ç»Ÿè®¾ç½®</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div style={{display:'flex', borderBottom:'1px solid rgba(255,255,255,0.1)', padding:'0 1rem', overflowX:'auto'}}>
                            {['basic', 'notification', 'quit', 'backup', 'security'].map(t => (
                                <div key={t} style={{padding:'1rem', cursor:'pointer', color: tab===t?'var(--primary)':'var(--text-secondary)', borderBottom: tab===t?'2px solid var(--primary)':'none', whiteSpace:'nowrap'}} onClick={() => setTab(t)}>
                                    {{basic:'åŸºç¡€', notification:'é€šçŸ¥ä¸äº¤äº’', quit:'é€€ç¾¤', backup:'å¤‡ä»½ä¸æ¢å¤', security:'å®‰å…¨'}[t]}
                                </div>
                            ))}
                        </div>
                        <div className="modal-body">
                            {tab === 'basic' && (
                                <>
                                    <div className="section-divider">ä¸»é¢˜è‰²</div>
                                    <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap'}}>
                                        {['#007AFF', '#BF5AF2', '#30D158', '#FF9500', '#FF453A', '#0A84FF'].map(c => (
                                            <div key={c} onClick={() => setConfig({...config, uiTheme: {...config.uiTheme, primaryColor: c}})} style={{width:'30px', height:'30px', borderRadius:'50%', background:c, border: config.uiTheme.primaryColor === c ? '2px solid white' : 'none'}} />
                                        ))}
                                    </div>
                                    <div className="section-divider">èƒŒæ™¯å›¾</div>
                                    <div style={{display:'flex', gap:'0.5rem'}}>
                                        <input className="form-control" value={config.uiTheme.backgroundImage || ''} onChange={e => setConfig({...config, uiTheme: {...config.uiTheme, backgroundImage: e.target.value}})} placeholder="URL" />
                                        <label className="btn btn-secondary" style={{marginBottom:0}}>ä¸Šä¼ <input type="file" style={{display:'none'}} onChange={uploadBg} /></label>
                                    </div>
                                </>
                            )}
                            {tab === 'notification' && (
                                <>
                                    <div className="section-divider">æŒ‡ä»¤é…ç½®</div>
                                    <div style={{display:'flex', gap:'1rem'}}>
                                        <div style={{flex:1}}>
                                            <label className="stat-label">å‰ç¼€ (Prefix)</label>
                                            <input className="form-control" value={config.cmdPrefix} onChange={e=>setConfig({...config, cmdPrefix:e.target.value})} placeholder="xa" />
                                        </div>
                                    </div>
                                    <div style={{display:'flex', gap:'1rem', marginTop:'0.5rem'}}>
                                        <div style={{flex:1}}>
                                            <label className="stat-label">æŸ¥è¯¢å…³é”®è¯</label>
                                            <input className="form-control" value={config.cmdQuery} onChange={e=>setConfig({...config, cmdQuery:e.target.value})} placeholder="æŸ¥è¯¢åˆ°æœŸ" />
                                        </div>
                                        <div style={{flex:1}}>
                                            <label className="stat-label">ç»­è´¹å…³é”®è¯</label>
                                            <input className="form-control" value={config.cmdRenew} onChange={e=>setConfig({...config, cmdRenew:e.target.value})} placeholder="ç»­è´¹" />
                                        </div>
                                    </div>

                                    <div className="section-divider">æ¶ˆæ¯æµ‹è¯•</div>
                                    <div style={{background:'rgba(255,255,255,0.03)', padding:'1rem', borderRadius:'var(--radius-sm)'}}>
                                        <input className="form-control" type="number" value={testTargetId} onChange={e=>setTestTargetId(e.target.value)} placeholder="æµ‹è¯•ç¾¤å·" />
                                        <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap', marginTop:'0.5rem'}}>
                                            <button className="btn btn-sm btn-secondary" onClick={() => handleTestMsg('warning')}>é¢„è­¦</button>
                                            <button className="btn btn-sm btn-secondary" onClick={() => handleTestMsg('expire')}>åˆ°æœŸ</button>
                                            <button className="btn btn-sm btn-secondary" onClick={() => handleTestMsg('renewal')}>ç»­è´¹</button>
                                            <button className="btn btn-sm btn-secondary" onClick={() => handleTestMsg('quit')}>é€€ç¾¤</button>
                                        </div>
                                    </div>
                                    <div className="section-divider">é€šçŸ¥å†…å®¹</div>
                                    <div className="form-group"><label className="stat-label">é¢„è­¦å†…å®¹</label><textarea className="form-control" value={config.warningMessage} onChange={e => setConfig({...config, warningMessage: e.target.value})} /></div>
                                    <div className="form-group"><label className="stat-label">åˆ°æœŸå†…å®¹</label><textarea className="form-control" value={config.defaultNotifyMessage} onChange={e => setConfig({...config, defaultNotifyMessage: e.target.value})} /></div>
                                </>
                            )}
                            {tab === 'quit' && (
                                <>
                                    <div className="section-divider">è‡ªåŠ¨é€€ç¾¤</div>
                                    <div style={{display:'flex', alignItems:'center', gap:'1rem'}}>
                                        <label className="switch"><input type="checkbox" checked={config.autoQuit} onChange={e => setConfig({...config, autoQuit: e.target.checked})} /><span className="slider round"></span></label>
                                        <span>{config.autoQuit ? 'å¼€å¯' : 'å…³é—­'}</span>
                                    </div>
                                    <div className="form-group" style={{marginTop:'1rem'}}><label className="stat-label">å»¶æ—¶(å°æ—¶)</label><input type="number" className="form-control" value={config.quitWaitHours} onChange={e => setConfig({...config, quitWaitHours: parseInt(e.target.value)})} /></div>
                                    <div className="form-group"><label className="stat-label">å‘Šåˆ«è¯­</label><textarea className="form-control" value={config.quitMessage} onChange={e => setConfig({...config, quitMessage: e.target.value})} /></div>
                                </>
                            )}
                            {tab === 'backup' && (
                                <>
                                    <div className="section-divider">å¤‡ä»½ç­–ç•¥</div>
                                    <div className="form-group"><label className="stat-label">ä¿ç•™å¤©æ•°</label><input type="number" className="form-control" value={config.backupRetentionDays} onChange={e => setConfig({...config, backupRetentionDays: parseInt(e.target.value)})} /></div>
                                    <div style={{display:'flex', gap:'0.5rem', marginTop:'0.5rem'}}>
                                        <button className="btn btn-primary" onClick={triggerBackup}>ç«‹å³å¤‡ä»½</button>
                                        <label className="btn btn-secondary" style={{marginBottom:0}}>ğŸ“¤ å¯¼å…¥å¹¶æ¢å¤<input type="file" style={{display:'none'}} onChange={restoreBackup} accept=".json" /></label>
                                    </div>
                                    <div className="section-divider">å¤‡ä»½åˆ—è¡¨</div>
                                    <div style={{maxHeight:'200px', overflowY:'auto'}}>
                                        {backups.length === 0 && <div style={{color:'var(--text-secondary)'}}>æš‚æ— å¤‡ä»½</div>}
                                        {backups.map(b => (
                                            <div key={b.name} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'0.5rem', borderBottom:'1px solid rgba(255,255,255,0.05)'}}>
                                                <div style={{overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', maxWidth:'180px'}}>
                                                    <div>{b.name}</div>
                                                    <div style={{fontSize:'0.7rem', color:'var(--text-secondary)'}}>{new Date(b.created).toLocaleString()} Â· {b.size}</div>
                                                </div>
                                                <button className="btn btn-sm btn-secondary" onClick={() => downloadBackup(b.name)}>â¬‡ï¸</button>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                            {tab === 'security' && (
                                <>
                                    <div className="section-divider">ä¿®æ”¹å¯†ç </div>
                                    <div className="form-group"><input className="form-control" value={passData.newUsername} onChange={e => setPassData({...passData, newUsername: e.target.value})} placeholder="æ–°ç”¨æˆ·å" /></div>
                                    <div className="form-group" style={{marginTop:'0.5rem'}}><input className="form-control" value={passData.newPassword} onChange={e => setPassData({...passData, newPassword: e.target.value})} placeholder="æ–°å¯†ç " /></div>
                                    <button className="btn btn-primary" style={{marginTop:'1rem'}} onClick={async () => {
                                        if (!passData.newUsername || !passData.newPassword) return;
                                        await fetch(`${apiHost}/api/admin/change-password`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(passData) });
                                        onLogout();
                                    }}>æ›´æ–°</button>
                                </>
                            )}
                        </div>
                        <div className="modal-actions"><button className="btn btn-primary" onClick={handleSaveConfig}>ä¿å­˜</button></div>
                    </div>
                </div>
            );
        };
        
        const LogViewerModal = ({ token, apiHost, onClose }) => {
            const [logs, setLogs] = useState([]);
            useEffect(() => { fetch(`${apiHost}/api/logs`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(setLogs); }, []);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header"><h3>æ—¥å¿—</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div className="modal-body log-list" style={{maxHeight:'60vh', overflowY:'auto'}}>
                            {logs.map(log => (
                                <div key={log.id} className="log-item">
                                    <div style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>{new Date(log.time).toLocaleString()}</div>
                                    <div style={{fontWeight:500}}>{log.action}</div>
                                    <div style={{color:'var(--text-secondary)', wordBreak:'break-all', fontSize:'0.9rem'}}>{log.details}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginHistoryModal = ({ token, apiHost, onClose }) => {
            const [history, setHistory] = useState([]);
            useEffect(() => { fetch(`${apiHost}/api/admin/login-history`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(setHistory); }, []);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header"><h3>ç™»å½•å†å²</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div className="modal-body" style={{maxHeight:'60vh', overflowY:'auto'}}>
                            <div style={{overflowX:'auto'}}>
                                <table className="history-table">
                                    <thead><tr><th>æ—¶é—´</th><th>ç”¨æˆ·</th><th>IP</th><th>å½’å±</th><th>çŠ¶æ€</th></tr></thead>
                                    <tbody>
                                        {history.map(h => (
                                            <tr key={h.id}>
                                                <td>{new Date(h.time).toLocaleString()}</td><td>{h.username}</td><td>{h.ip}</td><td>{h.location}</td>
                                                <td><span style={{color: h.status ? 'var(--success)' : 'var(--danger)'}}>{h.status ? 'æˆåŠŸ' : 'å¤±è´¥'}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AddBotModal = ({ token, apiHost, onClose, onSuccess }) => {
            const [id, setId] = useState('');
            const [name, setName] = useState('');
            const handleAdd = async () => {
                if (!id) return;
                await fetch(`${apiHost}/api/bot/create`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ id, name: name || `Bot ${id}` }) });
                onSuccess(); onClose();
            };
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'400px'}}>
                        <div className="modal-header"><h3>æ–°å¢å®ä¾‹</h3><button className="nav-btn" onClick={onClose}>âœ•</button></div>
                        <div className="modal-body">
                            <div className="form-group"><label className="stat-label">Bot ID</label><input type="number" className="form-control" value={id} onChange={e => setId(e.target.value)} placeholder="QQå·" /></div>
                            <div className="form-group" style={{marginTop:'1rem'}}><label className="stat-label">å¤‡æ³¨</label><input className="form-control" value={name} onChange={e => setName(e.target.value)} placeholder="åç§°" /></div>
                        </div>
                        <div className="modal-actions"><button className="btn btn-primary" onClick={handleAdd}>åˆ›å»º</button></div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NapCat ç®¡ç†ç»ˆç«¯</title>
    <link rel="stylesheet" href="index.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        const App = () => {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const apiHost = '';

            const handleLogin = (newToken) => {
                setToken(newToken);
                localStorage.setItem('token', newToken);
            };

            const handleLogout = () => {
                setToken(null);
                localStorage.removeItem('token');
            };

            // ç™»å½•åç«‹å³è·å–å…¨å±€é…ç½®åº”ç”¨ä¸»é¢˜
            useEffect(() => {
                if (token) {
                    fetch(`${apiHost}/api/admin/config`, { headers: { 'Authorization': `Bearer ${token}` } })
                        .then(r => r.json())
                        .then(config => {
                            if (config.uiTheme) {
                                applyTheme(config.uiTheme);
                            }
                        })
                        .catch(() => {});
                }
            }, [token]);

            const applyTheme = (theme) => {
                const target = document.body; 
                
                if (theme.primaryColor) target.style.setProperty('--primary', theme.primaryColor);
                
                if (theme.backgroundImage) {
                    target.style.setProperty('--bg-image', `url('${theme.backgroundImage}')`);
                } else {
                    target.style.removeProperty('--bg-image');
                }
                
                if (theme.overlayOpacity !== undefined) {
                    target.style.setProperty('--bg-overlay-opacity', theme.overlayOpacity);
                }
            };

            if (!token) return <LoginScreen onLogin={handleLogin} apiHost={apiHost} />;
            return <Dashboard token={token} apiHost={apiHost} onLogout={handleLogout} applyTheme={applyTheme} />;
        };

        const LoginScreen = ({ onLogin, apiHost }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${apiHost}/api/login`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        onLogin(data.token);
                    } else {
                        setError('è®¤è¯å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    }
                } catch (err) { setError(`è¿æ¥å¤±è´¥: ${err.message}`); } 
                finally { setLoading(false); }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <h2>NapCat Admin</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="stat-label" style={{textAlign:'left', marginLeft:'4px'}}>ç®¡ç†å‘˜è´¦å·</label>
                                <input type="text" className="form-control" value={username} onChange={e => setUsername(e.target.value)} placeholder="Username" />
                            </div>
                            <div className="form-group">
                                <label className="stat-label" style={{textAlign:'left', marginLeft:'4px', marginTop:'1rem'}}>è®¿é—®å¯†ç </label>
                                <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" />
                            </div>
                            {error && <div style={{color:'#FF453A', margin:'1.5rem 0', fontSize:'0.9rem'}}>{error}</div>}
                            <button type="submit" className="btn btn-primary" style={{width:'100%', marginTop:'1.5rem'}} disabled={loading}>
                                {loading ? 'Verifying...' : 'è¿›å…¥ç»ˆç«¯'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ token, apiHost, onLogout, applyTheme }) => {
            const [bots, setBots] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingBot, setEditingBot] = useState(null);
            const [msgBot, setMsgBot] = useState(null);
            const [showAdmin, setShowAdmin] = useState(false);
            const [showLogs, setShowLogs] = useState(false);
            const [showAddBot, setShowAddBot] = useState(false);
            const [showLoginHistory, setShowLoginHistory] = useState(false);
            const [wsUrl, setWsUrl] = useState('');

            useEffect(() => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                setWsUrl(`${protocol}//${window.location.host}/ws/napcat`);
            }, []);

            const fetchBots = async () => {
                try {
                    const res = await fetch(`${apiHost}/api/bots`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.status === 401 || res.status === 403) { onLogout(); return; }
                    const data = await res.json();
                    setBots(data);
                } catch (err) { console.error(err); } finally { setLoading(false); }
            };

            useEffect(() => {
                fetchBots();
                const interval = setInterval(fetchBots, 5000);
                return () => clearInterval(interval);
            }, [token]);

            return (
                <div className="dashboard">
                    {/* VisionOS style Floating Ornament Header */}
                    <div className="header-ornament">
                        <div className="header-title">
                            <span>NapCat Admin</span>
                            <span className="header-subtitle">{wsUrl}</span>
                        </div>
                        <div style={{width:'1px', height:'24px', background:'rgba(255,255,255,0.15)', margin:'0 8px'}}></div>
                        
                        <button onClick={() => setShowAddBot(true)} className="nav-btn" title="æ–°å¢å®ä¾‹">ï¼‹</button>
                        <button onClick={() => setShowLoginHistory(true)} className="nav-btn" title="ç™»å½•å†å²">ğŸ•’</button>
                        <button onClick={() => setShowLogs(true)} className="nav-btn" title="æ—¥å¿—å®¡è®¡">ğŸ“œ</button>
                        <button onClick={() => setShowAdmin(true)} className="nav-btn" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</button>
                        <button onClick={onLogout} className="nav-btn" style={{color:'#FF453A'}} title="é€€å‡º">âœ•</button>
                    </div>

                    {loading && bots.length === 0 ? (
                        <div style={{textAlign:'center', color:'rgba(255,255,255,0.5)', fontSize:'1.2rem', marginTop:'20vh'}}>
                            <div style={{marginBottom:'1rem'}}>â³</div> Loading...
                        </div>
                    ) : (
                        <div className="grid">
                            {bots.map(bot => (
                                <BotCard 
                                    key={bot.id} bot={bot} 
                                    onEdit={() => setEditingBot(bot)} onMsg={() => setMsgBot(bot)}
                                />
                            ))}
                            {bots.length === 0 && (
                                <div className="empty-state" style={{gridColumn:'1/-1', textAlign:'center', padding:'4rem', color:'rgba(255,255,255,0.4)'}}>
                                    <div style={{fontSize:'3rem', marginBottom:'1rem'}}>ğŸš€</div>
                                    <h3>æš‚æ— æœºå™¨äººå®ä¾‹</h3>
                                    <p>è¯·ç‚¹å‡»ä¸Šæ–¹ â€œï¼‹â€ æ–°å¢å®ä¾‹æˆ–é…ç½® WebSocket è¿æ¥ã€‚</p>
                                </div>
                            )}
                        </div>
                    )}

                    {editingBot && <EditBotModal bot={editingBot} token={token} apiHost={apiHost} onClose={() => setEditingBot(null)} onSuccess={fetchBots} />}
                    {msgBot && <SendMsgModal bot={msgBot} token={token} apiHost={apiHost} onClose={() => setMsgBot(null)} />}
                    {showAdmin && <AdminSettingsModal token={token} apiHost={apiHost} onClose={() => setShowAdmin(false)} onLogout={onLogout} applyTheme={applyTheme} />}
                    {showLogs && <LogViewerModal token={token} apiHost={apiHost} onClose={() => setShowLogs(false)} />}
                    {showLoginHistory && <LoginHistoryModal token={token} apiHost={apiHost} onClose={() => setShowLoginHistory(false)} />}
                    {showAddBot && <AddBotModal token={token} apiHost={apiHost} onClose={() => setShowAddBot(false)} onSuccess={fetchBots} />}
                </div>
            );
        };

        const BotCard = ({ bot, onEdit, onMsg }) => {
            const activeContracts = bot.contracts?.filter(c => !c.expireTime || c.expireTime > Date.now()).length || 0;
            const hasCustomAvatar = bot.avatar && (bot.avatar.startsWith('http') || bot.avatar.startsWith('/'));
            
            return (
                <div className="bot-card">
                    <div className={`status-badge ${bot.isOnline ? 'status-online' : 'status-offline'}`}>
                        <span className="status-dot"></span>
                        <span>{bot.isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                    
                    <div className="bot-info">
                        <div className="bot-avatar">
                            {hasCustomAvatar ? 
                                <img src={bot.avatar} alt="avatar" onError={(e)=>{e.target.style.display='none';e.target.parentElement.innerText='ğŸ‘¾'}} /> 
                                : (bot.avatar || 'ğŸ‘¾')
                            }
                        </div>
                        <div className="bot-details">
                            <h3>{bot.name}</h3>
                            <div className="bot-id">{bot.id}</div>
                        </div>
                    </div>
                    
                    <div className="stats-row">
                        <div className="stat-item">
                            <span className="stat-label">ç”Ÿæ•ˆç§Ÿæˆ·</span>
                            <span className="stat-value" style={{color: activeContracts > 0 ? 'var(--success)' : 'inherit'}}>{activeContracts}</span>
                        </div>
                        <div style={{width:'1px', background:'rgba(255,255,255,0.1)'}}></div>
                        <div className="stat-item">
                            <span className="stat-label">æ€»é…ç½®æ•°</span>
                            <span className="stat-value">{bot.contracts?.length || 0}</span>
                        </div>
                    </div>
                    
                    <div className="actions">
                        <button className="btn btn-primary" onClick={onEdit}>ç®¡ç†é…ç½®</button>
                        <button className="btn btn-secondary" onClick={onMsg} disabled={!bot.isOnline}>å‘é€æ¶ˆæ¯</button>
                    </div>
                </div>
            );
        };

        const ContractEditor = ({ contract, botId, token, apiHost, onSave, onCancel }) => {
            const toLocalISO = (ts) => {
                if (!ts) return '';
                const d = new Date(ts);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                return d.toISOString().slice(0, 16);
            };
            const [groupId, setGroupId] = useState(contract ? contract.groupId : '');
            const [groupName, setGroupName] = useState(contract ? contract.groupName : '');
            const [expireDate, setExpireDate] = useState(contract ? toLocalISO(contract.expireTime) : '');
            const [saving, setSaving] = useState(false);
            const [avatarUrl, setAvatarUrl] = useState('');

            // æ ¹æ®ç¾¤å·æ›´æ–°å¤´åƒé“¾æ¥
            useEffect(() => {
                if (groupId && groupId.length > 5) {
                    setAvatarUrl(`https://p.qlogo.cn/gh/${groupId}/${groupId}/100`);
                } else {
                    setAvatarUrl('');
                }
            }, [groupId]);

            const handleGroupBlur = async () => {
                if (!groupId || groupId.length < 5) return;
                // å¦‚æœè¿˜æ²¡æœ‰ç¾¤åï¼Œå°è¯•è‡ªåŠ¨è·å–
                if (!groupName) {
                    try {
                        const res = await fetch(`${apiHost}/api/bot/group-info`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ botId, groupId })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            if (data.groupName) setGroupName(data.groupName);
                        }
                    } catch (e) {
                        // Ignore error, maybe bot offline or timeout
                    }
                }
            };

            const addTime = (amount, unit) => {
                let base = expireDate ? new Date(expireDate) : new Date();
                if(base < new Date()) base = new Date();
                if (unit === 'day') base.setDate(base.getDate() + amount);
                if (unit === 'month') base.setMonth(base.getMonth() + amount);
                if (unit === 'year') base.setFullYear(base.getFullYear() + amount);
                setExpireDate(toLocalISO(base.getTime()));
            };

            const handleSave = async () => {
                if(!groupId) return alert("è¯·å¡«å†™ç¾¤å·");
                setSaving(true);
                try {
                    const res = await fetch(`${apiHost}/api/bot/contract/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            botId, contractId: contract?.id, groupId, groupName,
                            expireTime: expireDate ? new Date(expireDate).getTime() : null
                        })
                    });
                    if(res.ok) onSave(); else alert("ä¿å­˜å¤±è´¥");
                } catch(e) { alert("ç½‘ç»œé”™è¯¯"); } finally { setSaving(false); }
            };

            return (
                <div style={{animation: 'fadeIn 0.3s'}}>
                    <div className="section-divider">{contract ? 'ç¼–è¾‘æˆæƒ' : 'æ–°å»ºæˆæƒ'}</div>
                    <div style={{display:'flex', gap:'1rem', alignItems:'flex-start'}}>
                        {avatarUrl && (
                            <img src={avatarUrl} style={{width:'60px', height:'60px', borderRadius:'50%', border:'2px solid rgba(255,255,255,0.1)'}} alt="Group" onError={(e)=>e.target.style.display='none'}/>
                        )}
                        <div style={{flex:1}}>
                            <div className="form-group">
                                <label className="stat-label">ç›®æ ‡ç¾¤å· (è¾“å…¥åè‡ªåŠ¨åŒ¹é…)</label>
                                <input className="form-control" type="number" value={groupId} onChange={e=>setGroupId(e.target.value)} onBlur={handleGroupBlur} placeholder="QQ Group ID" />
                            </div>
                        </div>
                    </div>
                    
                    <div className="form-group" style={{marginTop:'1rem'}}>
                        <label className="stat-label">ç¾¤å¤‡æ³¨/åç§°</label>
                        <input className="form-control" value={groupName} onChange={e=>setGroupName(e.target.value)} placeholder="è¾“å…¥ç¾¤å·åå°è¯•è‡ªåŠ¨è·å–..." />
                    </div>

                    <div className="form-group" style={{marginTop:'1rem'}}>
                        <label className="stat-label">åˆ°æœŸæ—¶é—´</label>
                        <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap', marginBottom:'0.5rem'}}>
                            <button className="btn btn-sm btn-secondary" onClick={()=>addTime(1,'day')}>+1å¤©</button>
                            <button className="btn btn-sm btn-secondary" onClick={()=>addTime(1,'month')}>+1æœˆ</button>
                            <button className="btn btn-sm btn-secondary" onClick={()=>addTime(1,'year')}>+1å¹´</button>
                            <button className="btn btn-sm btn-secondary" onClick={()=>setExpireDate('')}>æ°¸ä¹…</button>
                        </div>
                        <input type="datetime-local" className="form-control" value={expireDate} onChange={e=>setExpireDate(e.target.value)} />
                    </div>
                    <div style={{display:'flex', justifyContent:'flex-end', gap:'0.5rem', marginTop:'2rem'}}>
                        <button className="btn btn-secondary" onClick={onCancel}>å–æ¶ˆ</button>
                        <button className="btn btn-primary" onClick={handleSave} disabled={saving}>ä¿å­˜é…ç½®</button>
                    </div>
                </div>
            );
        };

        const EditBotModal = ({ bot, token, apiHost, onClose, onSuccess }) => {
            const [contracts, setContracts] = useState(bot.contracts || []);
            const [botName, setBotName] = useState(bot.name);
            const [botAvatar, setBotAvatar] = useState(bot.avatar || '');
            const [editingContract, setEditingContract] = useState(null); 
            const [searchTerm, setSearchTerm] = useState('');
            const [realTimeGroups, setRealTimeGroups] = useState(new Set());
            const avatarInputRef = useRef(null);
            
            // æ‰“å¼€æ—¶æ£€æµ‹æœºå™¨äººå®é™…åœ¨ç¾¤åˆ—è¡¨
            useEffect(() => {
                if (bot.isOnline) {
                    fetch(`${apiHost}/api/bot/group-list`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ botId: bot.id })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (Array.isArray(data)) {
                            setRealTimeGroups(new Set(data.map(g => String(g.group_id))));
                        }
                    })
                    .catch(e => console.warn("Check groups failed", e));
                }
            }, []);

            const refreshData = async () => {
                const res = await fetch(`${apiHost}/api/bots`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const freshBot = data.find(b => b.id === bot.id);
                if (freshBot) {
                    setContracts(freshBot.contracts || []);
                    setBotName(freshBot.name);
                    setBotAvatar(freshBot.avatar || '');
                }
            };

            const updateBotInfo = async () => {
                await fetch(`${apiHost}/api/bot/update-info`, {
                    method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                    body: JSON.stringify({ id: bot.id, name: botName, avatar: botAvatar })
                });
                onSuccess();
                alert('ä¿å­˜æˆåŠŸ');
            };

            const handleAvatarUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('image', file);
                try {
                    const res = await fetch(`${apiHost}/api/upload`, { method:'POST', headers:{'Authorization':`Bearer ${token}`}, body:fd });
                    if(res.ok) {
                        const d = await res.json();
                        setBotAvatar(d.url); // ä½¿ç”¨ Web URL
                    }
                } catch(err) { console.error(err); alert('å¤´åƒä¸Šä¼ å¤±è´¥'); }
            };

            const deleteBot = async () => {
                if(!confirm(`ç¡®å®šåˆ é™¤ ${bot.name} å—ï¼Ÿ`)) return;
                await fetch(`${apiHost}/api/bot/delete`, {
                    method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${token}`},
                    body: JSON.stringify({ id: bot.id })
                });
                onSuccess(); onClose();
            };

            const deleteContract = async (contractId) => {
                if(!confirm("ç¡®å®šåˆ é™¤æ­¤æˆæƒï¼Ÿ")) return;
                await fetch(`${apiHost}/api/bot/contract/delete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ botId: bot.id, contractId })
                });
                refreshData();
            };
            
            const quitGroup = async (groupId) => {
                if(!bot.isOnline) return alert("æœºå™¨äººå¿…é¡»åœ¨çº¿æ‰èƒ½æ‰§è¡Œé€€ç¾¤æ“ä½œã€‚");
                if(!confirm(`âš ï¸ ç¡®å®šè¦å¼ºåˆ¶æœºå™¨äººé€€å‡ºç¾¤ ${groupId} å—ï¼Ÿ\né€€ç¾¤åå¦‚éœ€æ¢å¤ï¼Œéœ€é‡æ–°é‚€è¯·æœºå™¨äººè¿›ç¾¤ã€‚`)) return;
                
                try {
                    const res = await fetch(`${apiHost}/api/bot/quit-group`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ botId: bot.id, groupId })
                    });
                    if(res.ok) {
                        alert("é€€ç¾¤æŒ‡ä»¤å·²å‘é€");
                        refreshData();
                    } else {
                        const d = await res.json();
                        alert("æ“ä½œå¤±è´¥: " + (d.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
            };

            const filteredContracts = contracts.filter(c => 
                c.groupId.toString().includes(searchTerm) || 
                (c.groupName && c.groupName.includes(searchTerm))
            );
            const hasCustomAvatar = botAvatar && (botAvatar.startsWith('http') || botAvatar.startsWith('/'));

            return (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'800px', height:'600px'}}>
                        <div className="modal-header">
                            <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                                <input type="file" ref={avatarInputRef} style={{display:'none'}} onChange={handleAvatarUpload} />
                                <div 
                                    className="bot-avatar" 
                                    style={{width:44,height:44,fontSize:'1.2rem',cursor:'pointer',flexShrink:0}}
                                    onClick={() => avatarInputRef.current.click()}
                                    title="ç‚¹å‡»æ›´æ¢å¤´åƒ"
                                >
                                    {hasCustomAvatar ? 
                                        <img src={botAvatar} alt="avatar" onError={(e)=>{e.target.style.display='none';e.target.parentElement.innerText='ğŸ¤–'}}/> 
                                        : (botAvatar || 'ğŸ¤–')
                                    }
                                </div>
                                <div style={{display:'flex',gap:'0.5rem'}}>
                                    <input className="form-control" style={{padding:'0.4rem 0.8rem',width:'160px'}} value={botName} onChange={e=>setBotName(e.target.value)} />
                                    <button className="btn btn-sm btn-secondary" onClick={updateBotInfo}>ä¿å­˜</button>
                                </div>
                            </div>
                            <div style={{display:'flex', gap:'0.5rem'}}>
                                <button className="btn btn-sm btn-danger" onClick={deleteBot}>åˆ é™¤å®ä¾‹</button>
                                <button className="btn btn-sm btn-secondary" onClick={onClose}>å…³é—­</button>
                            </div>
                        </div>
                        <div className="modal-body">
                            {!editingContract ? (
                                <>
                                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'1.5rem'}}>
                                        <input className="form-control" style={{width:'240px'}} placeholder="ğŸ” æœç´¢ç¾¤å·/ç¾¤å..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        <button className="btn btn-primary" onClick={()=>setEditingContract('new')}>ï¼‹ æ·»åŠ æˆæƒ</button>
                                    </div>
                                    <div className="contract-list">
                                        {filteredContracts.map(c => {
                                            const isExpired = c.expireTime && Date.now() > c.expireTime;
                                            const groupAvatarUrl = `https://p.qlogo.cn/gh/${c.groupId}/${c.groupId}/100`;
                                            // æ£€æŸ¥æœºå™¨äººæ˜¯å¦å®é™…åœ¨ç¾¤å†… (ä»…åœ¨æœºå™¨äººåœ¨çº¿æ—¶æ£€æµ‹)
                                            const isInGroup = bot.isOnline ? realTimeGroups.has(String(c.groupId)) : true;
                                            
                                            return (
                                                <div key={c.id} className="contract-item">
                                                    <div style={{display:'flex', gap:'0.5rem', alignItems:'center', flex:1}}>
                                                        <img src={groupAvatarUrl} className="group-avatar" alt="Group" onError={(e)=>e.target.src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'}/>
                                                        <div>
                                                            <div style={{fontWeight:'600', fontSize:'1rem', display:'flex', alignItems:'center', gap:'8px'}}>
                                                                {c.groupName || 'æœªå‘½åç¾¤'}
                                                                {c.leftGroup && <span className="tag-left">å·²é€€ç¾¤</span>}
                                                                {!c.leftGroup && !isInGroup && bot.isOnline && <span className="tag-missing">âš ï¸ æœºå™¨äººä¸åœ¨è¯¥ç¾¤</span>}
                                                            </div>
                                                            <div style={{fontSize:'0.8rem', color:'var(--text-secondary)', marginTop:'2px'}}>ID: {c.groupId}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{display:'flex', alignItems:'center', gap:'1rem'}}>
                                                        <div style={{textAlign:'right'}}>
                                                            <div style={{fontSize:'0.9rem', color: isExpired ? 'var(--danger)' : 'var(--success)'}}>
                                                                {c.expireTime ? (isExpired?'å·²è¿‡æœŸ':'ç”Ÿæ•ˆä¸­') : 'æ°¸ä¹…æœ‰æ•ˆ'}
                                                            </div>
                                                            <div style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>
                                                                {c.expireTime ? new Date(c.expireTime).toLocaleDateString() : 'âˆ'}
                                                            </div>
                                                        </div>
                                                        <div style={{display:'flex', gap:'0.5rem'}}>
                                                            {!c.leftGroup && isExpired && bot.isOnline && isInGroup && (
                                                                <button className="btn btn-sm btn-warning" onClick={()=>quitGroup(c.groupId)} title="å¼ºåˆ¶é€€å‡ºè¯¥ç¾¤">é€€ç¾¤</button>
                                                            )}
                                                            <button className="btn btn-sm btn-secondary" onClick={()=>setEditingContract(c)}>ç¼–è¾‘</button>
                                                            <button className="btn btn-sm btn-danger" onClick={()=>deleteContract(c.id)}>åˆ é™¤</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {filteredContracts.length === 0 && <div style={{textAlign:'center',color:'var(--text-muted)',padding:'2rem'}}>æœªæ‰¾åˆ°ç›¸å…³æˆæƒè®°å½•</div>}
                                    </div>
                                </>
                            ) : (
                                <ContractEditor contract={editingContract==='new'?null:editingContract} botId={bot.id} token={token} apiHost={apiHost} onSave={()=>{setEditingContract(null);refreshData();}} onCancel={()=>setEditingContract(null)} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LogViewerModal = ({ token, apiHost, onClose }) => {
            const [logs, setLogs] = useState([]);
            useEffect(() => {
                fetch(`${apiHost}/api/logs`, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(res => res.json()).then(setLogs);
            }, []);

            return (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'900px', height:'80vh'}}>
                        <div className="modal-header"><h3>ğŸ“œ æ—¥å¿—</h3><button className="btn btn-sm btn-secondary" onClick={onClose}>å…³é—­</button></div>
                        <div className="modal-body" style={{padding:0}}>
                            <div className="log-list" style={{border:'none', borderRadius:0, height:'100%'}}>
                                {logs.map(l => (
                                    <div key={l.id} className="log-item">
                                        <div style={{color:'var(--text-muted)', fontFamily:'monospace'}}>{new Date(l.time).toLocaleString()}</div>
                                        <div className={`log-type ${l.type}`}>{l.type}</div>
                                        <div style={{fontWeight:600}}>{l.action}</div>
                                        <div style={{color:'var(--text-secondary)', wordBreak:'break-all'}}>{l.details}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginHistoryModal = ({ token, apiHost, onClose }) => {
            const [history, setHistory] = useState([]);
            useEffect(() => {
                fetch(`${apiHost}/api/admin/login-history`, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(res => res.json()).then(setHistory);
            }, []);

            return (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'800px', height:'80vh'}}>
                        <div className="modal-header"><h3>ğŸ•’ ç™»å½•å†å²</h3><button className="btn btn-sm btn-secondary" onClick={onClose}>å…³é—­</button></div>
                        <div className="modal-body" style={{padding:0}}>
                            <table className="history-table">
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>IP åœ°å€</th>
                                        <th>å½’å±åœ°</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {history.map(h => (
                                        <tr key={h.id}>
                                            <td>{new Date(h.time).toLocaleString()}</td>
                                            <td style={{fontFamily:'monospace'}}>{h.ip}</td>
                                            <td>{h.location}</td>
                                            <td>{h.username}</td>
                                            <td>
                                                <span style={{color: h.status ? 'var(--success)' : 'var(--danger)'}}>
                                                    {h.status ? 'æˆåŠŸ' : 'å¤±è´¥'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                    {history.length === 0 && <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>æš‚æ— è®°å½•</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminSettingsModal = ({ token, apiHost, onClose, onLogout, applyTheme }) => {
            const [config, setConfig] = useState({});
            const [uploading, setUploading] = useState(false);
            const fileInputRef = useRef(null);
            const bgInputRef = useRef(null);
            const [username, setUsername] = useState('admin');
            const [password, setPassword] = useState('');
            
            // Theme states
            const [primaryColor, setPrimaryColor] = useState('#007AFF');
            const [bgImage, setBgImage] = useState('');
            const [opacity, setOpacity] = useState(0.4);

            useEffect(() => {
                fetch(`${apiHost}/api/admin/config`, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(r => r.json())
                    .then(data => {
                        setConfig(data);
                        if(data.uiTheme) {
                            setPrimaryColor(data.uiTheme.primaryColor || '#007AFF');
                            setBgImage(data.uiTheme.backgroundImage || '');
                            setOpacity(data.uiTheme.overlayOpacity ?? 0.4);
                        }
                    });
            }, []);

            const saveConfig = async () => {
                const newConfig = {
                    ...config,
                    uiTheme: {
                        primaryColor,
                        backgroundImage: bgImage,
                        overlayOpacity: parseFloat(opacity)
                    }
                };
                await fetch(`${apiHost}/api/admin/config`, {
                    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                    body: JSON.stringify(newConfig)
                });
                applyTheme(newConfig.uiTheme);
                alert("é…ç½®å·²ä¿å­˜");
            };

            const handleUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('image', file);
                setUploading(true);
                try {
                    const res = await fetch(`${apiHost}/api/upload`, { method:'POST', headers:{'Authorization':`Bearer ${token}`}, body:fd });
                    if(res.ok) {
                        const d = await res.json();
                        if (type === 'renewal') {
                            let path = d.path.replace(/\\/g, '/');
                            if(!path.startsWith('/')) path = '/' + path;
                            setConfig(p => ({ ...p, renewalMessage: (p.renewalMessage||'') + `\n[CQ:image,file=file://${path}]` }));
                        } else if (type === 'background') {
                            setBgImage(d.url);
                        }
                    }
                } finally { setUploading(false); }
            };

            const backupNow = async () => {
                if(!confirm("ç«‹å³æ‰§è¡Œå¤‡ä»½ï¼Ÿ")) return;
                await fetch(`${apiHost}/api/backup/now`, { method:'POST', headers:{'Authorization':`Bearer ${token}`} });
                alert("å¤‡ä»½ä»»åŠ¡å·²è§¦å‘");
            };

            const changePwd = async () => {
                if(!confirm("ä¿®æ”¹å¯†ç éœ€é‡æ–°ç™»å½•")) return;
                await fetch(`${apiHost}/api/admin/change-password`, {
                    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                    body: JSON.stringify({ newUsername: username, newPassword: password })
                });
                onLogout();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'650px'}}>
                        <div className="modal-header"><h3>ğŸ›  ç³»ç»Ÿé…ç½®</h3></div>
                        <div className="modal-body">
                            
                            <div className="section-divider">ğŸ¨ ä¸ªæ€§åŒ– (VisionOS)</div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'1rem'}}>
                                <div className="form-group">
                                    <label className="stat-label">ä¸»é¢˜ä¸»è‰²</label>
                                    <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                        <input type="color" value={primaryColor} onChange={e=>setPrimaryColor(e.target.value)} style={{width:'40px', height:'40px', padding:0, border:'none', borderRadius:'50%', overflow:'hidden', cursor:'pointer'}} />
                                        <input className="form-control" value={primaryColor} onChange={e=>setPrimaryColor(e.target.value)} />
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label className="stat-label">èƒŒæ™¯é®ç½©æµ“åº¦ ({opacity})</label>
                                    <input type="range" min="0" max="1" step="0.1" value={opacity} onChange={e=>setOpacity(e.target.value)} style={{width:'100%'}} />
                                </div>
                            </div>
                            <div className="form-group" style={{marginTop:'1rem'}}>
                                <label className="stat-label">èƒŒæ™¯å›¾ç‰‡ (URL æˆ–ä¸Šä¼ )</label>
                                <div style={{display:'flex', gap:'0.5rem'}}>
                                    <input className="form-control" value={bgImage} onChange={e=>setBgImage(e.target.value)} placeholder="https://..." />
                                    <input type="file" ref={bgInputRef} style={{display:'none'}} onChange={(e)=>handleUpload(e, 'background')} />
                                    <button className="btn btn-secondary" onClick={()=>bgInputRef.current.click()} disabled={uploading}>ğŸ“¤ ä¸Šä¼ </button>
                                    <button className="btn btn-secondary" onClick={()=>setBgImage('')}>ğŸš« é‡ç½®</button>
                                </div>
                            </div>

                            <div className="section-divider">è‡ªåŠ¨é€€ç¾¤ç­–ç•¥ (é«˜çº§)</div>
                            <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'1rem'}}>
                                <label className="stat-label" style={{margin:0, fontSize:'1rem'}}>å¼€å¯åˆ°æœŸè‡ªåŠ¨é€€ç¾¤</label>
                                <input type="checkbox" style={{transform:'scale(1.5)'}} checked={config.autoQuit||false} onChange={e=>setConfig({...config, autoQuit:e.target.checked})} />
                            </div>
                            {config.autoQuit && (
                                <div style={{animation:'fadeIn 0.3s'}}>
                                    <div className="form-group">
                                        <label className="stat-label">åˆ°æœŸåç­‰å¾… (å°æ—¶)</label>
                                        <input type="number" className="form-control" value={config.quitWaitHours||24} onChange={e=>setConfig({...config,quitWaitHours:parseInt(e.target.value)})} />
                                    </div>
                                    <div className="form-group" style={{marginTop:'1rem'}}>
                                        <label className="stat-label">é€€ç¾¤å‘Šåˆ«è¯­</label>
                                        <textarea className="form-control" value={config.quitMessage||''} onChange={e=>setConfig({...config,quitMessage:e.target.value})} rows="2"></textarea>
                                    </div>
                                </div>
                            )}

                            <div className="section-divider">å›å¤ä¸é€šçŸ¥</div>
                            <div className="form-group">
                                <label className="stat-label">åˆ°æœŸé€šçŸ¥å†…å®¹</label>
                                <textarea className="form-control" value={config.defaultNotifyMessage||''} onChange={e=>setConfig({...config,defaultNotifyMessage:e.target.value})} rows="2"></textarea>
                            </div>
                            <div className="form-group" style={{marginTop:'1rem'}}>
                                <label className="stat-label">é¢„è­¦è®¾ç½® (æå‰å¤©æ•°)</label>
                                <input type="number" className="form-control" value={config.warningDays||3} onChange={e=>setConfig({...config,warningDays:parseInt(e.target.value)})} />
                            </div>
                            <div className="form-group" style={{marginTop:'1rem'}}>
                                <label className="stat-label">é¢„è­¦é€šçŸ¥å†…å®¹</label>
                                <textarea className="form-control" value={config.warningMessage||''} onChange={e=>setConfig({...config,warningMessage:e.target.value})} rows="2"></textarea>
                            </div>
                            <div className="form-group" style={{marginTop:'1rem'}}>
                                <label className="stat-label">ç»­è´¹å›å¤ (æŒ‡ä»¤: xaç»­è´¹)</label>
                                <textarea className="form-control" value={config.renewalMessage||''} onChange={e=>setConfig({...config,renewalMessage:e.target.value})} rows="3"></textarea>
                                <div style={{marginTop:8}}>
                                    <input type="file" ref={fileInputRef} style={{display:'none'}} onChange={(e)=>handleUpload(e, 'renewal')} />
                                    <button className="btn btn-sm btn-secondary" onClick={()=>fileInputRef.current.click()} disabled={uploading}>ğŸ“· æ’å…¥æ”¶æ¬¾ç /å›¾ç‰‡</button>
                                </div>
                            </div>
                            
                            <div className="section-divider">è¿ç»´ä¸å®‰å…¨</div>
                            <div className="form-group">
                                <label className="stat-label">å¤‡ä»½ä¿ç•™å¤©æ•°</label>
                                <input type="number" className="form-control" value={config.backupRetentionDays||7} onChange={e=>setConfig({...config,backupRetentionDays:parseInt(e.target.value)})} />
                            </div>
                            <div style={{marginBottom:'1rem', display:'flex', justifyContent:'space-between', marginTop:'1rem'}}>
                                <button className="btn btn-sm btn-secondary" onClick={backupNow}>ğŸ“‚ ç«‹å³å¤‡ä»½æ•°æ®</button>
                                <button className="btn btn-sm btn-primary" onClick={saveConfig}>ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
                            </div>

                            <div className="section-divider">è´¦æˆ·ç®¡ç†</div>
                            <div className="form-group"><input className="form-control" value={username} onChange={e=>setUsername(e.target.value)} placeholder="æ–°ç”¨æˆ·å"/></div>
                            <div className="form-group" style={{marginTop:'0.5rem'}}><input className="form-control" type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="æ–°å¯†ç "/></div>
                            <button className="btn btn-sm btn-danger" style={{width:'100%', marginTop:'1rem'}} onClick={changePwd}>æ›´æ–°ç®¡ç†å‘˜è´¦å· (éœ€é‡ç™»)</button>
                        </div>
                        <div className="modal-actions"><button className="btn btn-secondary" onClick={onClose}>å…³é—­</button></div>
                    </div>
                </div>
            );
        };

        const AddBotModal = ({ token, apiHost, onClose, onSuccess }) => {
            const [id, setId] = useState('');
            const [name, setName] = useState('');
            const add = async () => {
                if(!id) return;
                const res = await fetch(`${apiHost}/api/bot/create`, {
                    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                    body: JSON.stringify({ id, name })
                });
                if(res.ok) { onSuccess(); onClose(); } else alert("æ·»åŠ å¤±è´¥");
            };
            return (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'450px'}}>
                        <div className="modal-header"><h3>æ–°å¢å®ä¾‹</h3></div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label className="stat-label">Bot QQ</label>
                                <input className="form-control" value={id} onChange={e=>setId(e.target.value)} placeholder="QQå·"/>
                            </div>
                            <div className="form-group" style={{marginTop:'1rem'}}>
                                <label className="stat-label">å¤‡æ³¨å</label>
                                <input className="form-control" value={name} onChange={e=>setName(e.target.value)} placeholder="å¯é€‰å¤‡æ³¨"/>
                            </div>
                        </div>
                        <div className="modal-actions"><button className="btn btn-secondary" onClick={onClose}>å–æ¶ˆ</button><button className="btn btn-primary" onClick={add}>ç¡®è®¤æ·»åŠ </button></div>
                    </div>
                </div>
            );
        };

        const SendMsgModal = ({ bot, token, apiHost, onClose }) => {
            const [gid, setGid] = useState('');
            const [msg, setMsg] = useState('');
            const [search, setSearch] = useState('');
            const contracts = bot.contracts || [];
            const filteredGroups = contracts.filter(c => String(c.groupId).includes(search));

            const send = async () => {
                if(!gid||!msg) return;
                const res = await fetch(`${apiHost}/api/bot/send`, {
                    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                    body:JSON.stringify({id:bot.id, group_id:gid, message:msg})
                });
                if(res.ok) { alert('å‘é€æˆåŠŸ'); setMsg(''); } else alert('å‘é€å¤±è´¥');
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h3>å‘é€æ¶ˆæ¯ ({bot.name})</h3></div>
                        <div className="modal-body">
                            <div className="form-group"><label className="stat-label">ç›®æ ‡ç¾¤å·</label><input className="form-control" value={gid} onChange={e=>setGid(e.target.value)}/></div>
                            <div className="form-group" style={{marginTop:'1rem'}}><label className="stat-label">æ¶ˆæ¯å†…å®¹</label><textarea className="form-control" value={msg} onChange={e=>setMsg(e.target.value)} rows="4"></textarea></div>
                            
                            <div className="section-divider">ç¾¤åˆ—è¡¨é€‰æ‹©</div>
                            <input className="form-control" placeholder="ğŸ” æœç´¢ç¾¤å·..." value={search} onChange={e=>setSearch(e.target.value)} style={{marginBottom:'0.5rem'}}/>
                            <div className="log-list" style={{maxHeight:'150px', overflowY:'auto'}}>
                                {filteredGroups.map(c => (
                                    <div key={c.id} className="log-item" style={{gridTemplateColumns:'1fr', cursor:'pointer', padding:'0.5rem'}} onClick={()=>setGid(c.groupId)}>
                                        <div style={{display:'flex',justifyContent:'space-between'}}>
                                            <span style={{fontWeight:600}}>ç¾¤ {c.groupId}</span>
                                            <span style={{fontSize:'0.8rem', color:'var(--text-secondary)'}}>{c.expireTime ? new Date(c.expireTime).toLocaleDateString() : 'æ°¸ä¹…'}</span>
                                        </div>
                                    </div>
                                ))}
                                {filteredGroups.length === 0 && <div style={{padding:'0.5rem', textAlign:'center', color:'var(--text-muted)'}}>æ— åŒ¹é…ç¾¤</div>}
                            </div>

                        </div>
                        <div className="modal-actions"><button className="btn btn-secondary" onClick={onClose}>å…³é—­</button><button className="btn btn-primary" onClick={send}>å‘é€</button></div>
                    </div>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
